--=[ THE FORGE: СВОБОДНАЯ КАМЕРА + УДАЛЁННОЕ ВЗАИМОДЕЙСТВИЕ ]=--
-- Камера летает свободно, персонаж стоит на месте

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = workspace.CurrentCamera

-- Состояние
local FreeCameraMode = false
local Agent = nil

-- Параметры свободной камеры
local CameraSpeed = 0.5
local LookSensitivity = 0.3
local CameraYaw = 0
local CameraPitch = 0
local CameraPosition = Vector3.new(0, 0, 0)

-- 1. ИНТЕРФЕЙС (упрощённый, только кнопка)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ForgeFreeCam"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false

-- Кнопка переключения режима
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Name = "ToggleBtn"
ToggleBtn.Size = UDim2.new(0, 120, 0, 50)
ToggleBtn.Position = UDim2.new(0, 20, 0, 20)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 60)
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.Text = "ВКЛ СВОБ.КАМЕРУ"
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 16
ToggleBtn.BorderSizePixel = 0
ToggleBtn.ZIndex = 10

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0.2, 0)
UICorner.Parent = ToggleBtn

ToggleBtn.Parent = ScreenGui

-- 2. ЯДРО СВОБОДНОЙ КАМЕРЫ (СПЕКТАТОР)
function StartFreeCamera()
    local character = LocalPlayer.Character
    if not character then return end
    
    -- Замораживаем персонажа
    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = 0
        humanoid.JumpPower = 0
    end
    
    -- Создаём агента для взаимодействий
    Agent = Instance.new("Part")
    Agent.Name = "FreeCamAgent"
    Agent.Size = Vector3.new(3, 5, 3)
    Agent.Transparency = 1
    Agent.CanCollide = false
    Agent.Anchored = true
    Agent.Parent = workspace
    Agent.CFrame = character:GetPivot()
    
    -- Сохраняем стартовую позицию камеры
    CameraPosition = Camera.CFrame.Position
    CameraYaw = 0
    CameraPitch = 0
    
    -- Переводим камеру в ручной режим
    Camera.CameraType = Enum.CameraType.Scriptable
    
    print("Свободная камера активирована. Персонаж заморожен.")
    print("Управление: касание + движение = вращение камеры")
end

function StopFreeCamera()
    local character = LocalPlayer.Character
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = 16
            humanoid.JumpPower = 50
        end
    end
    
    -- Возвращаем камеру к персонажу
    Camera.CameraType = Enum.CameraType.Custom
    
    -- Удаляем агента
    if Agent then
        Agent:Destroy()
        Agent = nil
    end
    
    print("Свободная камера деактивирована.")
end

-- 3. УПРАВЛЕНИЕ КАМЕРОЙ (как в спектаторе)
local TouchStartPos = nil
local TouchStartCameraYaw = 0
local TouchStartCameraPitch = 0

UserInputService.TouchStarted:Connect(function(touch, gameProcessed)
    if not FreeCameraMode or gameProcessed then return end
    
    TouchStartPos = touch.Position
    TouchStartCameraYaw = CameraYaw
    TouchStartCameraPitch = CameraPitch
end)

UserInputService.TouchMoved:Connect(function(touch, gameProcessed)
    if not FreeCameraMode or not TouchStartPos or gameProcessed then return end
    
    local delta = touch.Position - TouchStartPos
    CameraYaw = TouchStartCameraYaw - delta.X * LookSensitivity
    CameraPitch = TouchStartCameraPitch + delta.Y * LookSensitivity
    CameraPitch = math.clamp(CameraPitch, -89, 89)
end)

UserInputService.TouchEnded:Connect(function(touch, gameProcessed)
    TouchStartPos = nil
end)

-- Движение камеры вперёд/назад/вбок
local MoveForward = false
local MoveBackward = false
local MoveLeft = false
local MoveRight = false
local MoveUp = false
local MoveDown = false

-- Временные кнопки для движения (можно заменить на виртуальный джойстик)
local function CreateMoveButtons()
    local moveFrame = Instance.new("Frame")
    moveFrame.Name = "MoveControls"
    moveFrame.Size = UDim2.new(0, 200, 0, 200)
    moveFrame.Position = UDim2.new(1, -220, 0, 20)
    moveFrame.BackgroundTransparency = 0.8
    moveFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    moveFrame.Parent = ScreenGui
    
    -- Кнопки движения (простой вариант)
    local directions = {
        {"W", "Вперёд", UDim2.new(0.5, -25, 0, 10), function(v) MoveForward = v end},
        {"S", "Назад", UDim2.new(0.5, -25, 0.7, 10), function(v) MoveBackward = v end},
        {"A", "Влево", UDim2.new(0, 10, 0.35, 0), function(v) MoveLeft = v end},
        {"D", "Вправо", UDim2.new(1, -50, 0.35, 0), function(v) MoveRight = v end},
    }
    
    for _, dir in pairs(directions) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, 40, 0, 40)
        btn.Position = dir[3]
        btn.Text = dir[1]
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 18
        btn.BackgroundColor3 = Color3.fromRGB(80, 80, 120)
        btn.Parent = moveFrame
        
        btn.MouseButton1Down:Connect(function() dir[4](true) end)
        btn.MouseButton1Up:Connect(function() dir[4](false) end)
        btn.MouseLeave:Connect(function() dir[4](false) end)
    end
    
    print("Созданы кнопки движения W/A/S/D в правом верхнем углу")
end

-- 4. ОБНОВЛЕНИЕ КАМЕРЫ
RunService.RenderStepped:Connect(function(deltaTime)
    if not FreeCameraMode then return end
    
    -- Вычисляем векторы направления
    local forward = Vector3.new(
        math.sin(math.rad(CameraYaw)) * math.cos(math.rad(CameraPitch)),
        math.sin(math.rad(CameraPitch)),
        math.cos(math.rad(CameraYaw)) * math.cos(math.rad(CameraPitch))
    )
    
    local right = Vector3.new(
        math.sin(math.rad(CameraYaw + 90)),
        0,
        math.cos(math.rad(CameraYaw + 90))
    )
    
    local up = Vector3.new(0, 1, 0)
    
    -- Движение
    local moveVector = Vector3.new(0, 0, 0)
    if MoveForward then moveVector = moveVector + forward end
    if MoveBackward then moveVector = moveVector - forward end
    if MoveRight then moveVector = moveVector + right end
    if MoveLeft then moveVector = moveVector - right end
    if MoveUp then moveVector = moveVector + up end
    if MoveDown then moveVector = moveVector - up end
    
    -- Нормализуем и применяем скорость
    if moveVector.Magnitude > 0 then
        moveVector = moveVector.Unit * CameraSpeed * 60 * deltaTime
        CameraPosition = CameraPosition + moveVector
    end
    
    -- Обновляем позицию камеры
    Camera.CFrame = CFrame.new(CameraPosition, CameraPosition + forward)
end)

-- 5. ВЗАИМОДЕЙСТВИЕ (через агента)
function RemoteInteract(target)
    if not Agent or not FreeCameraMode then 
        print("Ошибка: Режим не активен")
        return 
    end
    
    local targetName = target.Name:lower()
    
    -- Для руды
    if targetName:find("ore") or targetName:find("руд") or target.Parent.Name:find("ore") then
        local clickDetector = target:FindFirstChild("ClickDetector") 
                        or target.Parent:FindFirstChild("ClickDetector")
        if clickDetector then
            -- Перемещаем агента к цели
            Agent.CFrame = CFrame.new(target.Position)
            wait(0.05)
            fireclickdetector(clickDetector)
            print("Добыча: " .. targetName)
            return true
        end
    end
    
    -- Для врагов
    if targetName:find("mob") or targetName:find("enemy") or target:FindFirstChild("Humanoid") then
        local humanoid = target:FindFirstChild("Humanoid") or target.Parent:FindFirstChild("Humanoid")
        if humanoid then
            Agent.CFrame = CFrame.new(target.Position)
            humanoid:TakeDamage(20)
            print("Атака: " .. targetName)
            return true
        end
    end
    
    -- Любой кликабельный объект
    local clickDetector = target:FindFirstChild("ClickDetector")
    if clickDetector then
        Agent.CFrame = CFrame.new(target.Position)
        wait(0.05)
        fireclickdetector(clickDetector)
        print("Взаимодействие: " .. targetName)
        return true
    end
    
    return false
end

-- 6. КЛИКИ ПО ОБЪЕКТАМ
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not FreeCameraMode or gameProcessed then return end
    
    if input.UserInputType == Enum.UserInputType.Touch then
        -- Ждём, чтобы отличить от жеста камеры
        task.wait(0.2)
        if TouchStartPos then return end -- Если был жест камеры, пропускаем
        
        -- Луч от камеры
        local ray = Camera:ViewportPointToRay(input.Position.X, input.Position.Y)
        local hitPart = workspace:FindPartOnRayWithIgnoreList(
            Ray.new(ray.Origin, ray.Direction * 200),
            {Camera, Agent}
        )
        
        if hitPart then
            RemoteInteract(hitPart)
        end
    end
end)

-- 7. ПЕРЕКЛЮЧЕНИЕ РЕЖИМА
ToggleBtn.MouseButton1Click:Connect(function()
    FreeCameraMode = not FreeCameraMode
    
    if FreeCameraMode then
        StartFreeCamera()
        ToggleBtn.Text = "ВЫКЛ СВОБ.КАМЕРУ"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
        CreateMoveButtons()
    else
        StopFreeCamera()
        ToggleBtn.Text = "ВКЛ СВОБ.КАМЕРУ"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 60)
        
        -- Удаляем кнопки движения
        local moveControls = ScreenGui:FindFirstChild("MoveControls")
        if moveControls then moveControls:Destroy() end
    end
end)

print("=========================================")
print("СКРИПТ ЗАГРУЖЕН: Свободная камера для The Forge")
print("Инструкция:")
print("1. Нажмите кнопку 'ВКЛ СВОБ.КАМЕРУ'")
print("2. Персонаж замрёт на месте")
print("3. Касайтесь и двигайте пальцем для вращения камеры")
print("4. Используйте кнопки W/A/S/D для движения камеры")
print("5. Нажимайте на объекты для взаимодействия")
print("=========================================")
