-- Compact Mobile Fly & Mark System
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- State
local markers = {}
local isFlying = false
local isViewing = false
local currentMarker = 0
local flyPos = Vector3.new(0, 0, 0)
local viewAngle = Vector2.new(0, 0)
local flyDir = {F=false, B=false, L=false, R=false, U=false, D=false}

-- Create simple GUI
local gui = Instance.new("ScreenGui")
gui.Name = "FlyMarkSystem"
gui.Parent = playerGui

-- Main buttons panel
local panel = Instance.new("Frame")
panel.Size = UDim2.new(0, 200, 0, 250)
panel.Position = UDim2.new(0.02, 0, 0.3, 0)
panel.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
panel.BorderSizePixel = 0
panel.Parent = gui

Instance.new("UICorner", panel).CornerRadius = UDim.new(0, 10)

-- Status display
local status = Instance.new("TextLabel")
status.Size = UDim2.new(1, -20, 0, 60)
status.Position = UDim2.new(0, 10, 0, 10)
status.BackgroundTransparency = 1
status.Text = "FLIGHT SYSTEM\nMarkers: 0/5"
status.TextColor3 = Color3.fromRGB(200, 200, 255)
status.Font = Enum.Font.Gotham
status.TextSize = 14
status.TextWrapped = true
status.Parent = panel

-- Button creation
local function createBtn(name, text, posY, color)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Size = UDim2.new(0.9, 0, 0, 40)
    btn.Position = UDim2.new(0.05, 0, posY, 0)
    btn.BackgroundColor3 = color
    btn.Text = text
    btn.TextColor3 = Color3.white
    btn.Font = Enum.Font.GothamMedium
    btn.TextSize = 14
    btn.AutoButtonColor = false
    btn.Parent = panel
    
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    
    -- Simple hover effect
    btn.MouseEnter:Connect(function()
        btn.BackgroundColor3 = color * 1.2
    end)
    btn.MouseLeave:Connect(function()
        btn.BackgroundColor3 = color
    end)
    
    return btn
end

-- Create main buttons
local flyBtn = createBtn("FlyBtn", "ðŸŽ® FLY MODE", 0.3, Color3.fromRGB(0, 150, 255))
local markBtn = createBtn("MarkBtn", "ðŸ“ MARK SPOT", 0.48, Color3.fromRGB(255, 180, 0))
local viewBtn = createBtn("ViewBtn", "ðŸ‘ VIEW MARKS", 0.66, Color3.fromRGB(150, 0, 255))
local clearBtn = createBtn("ClearBtn", "ðŸ—‘ CLEAR ALL", 0.84, Color3.fromRGB(255, 60, 60))

-- Fly controls (hidden initially)
local flyPanel = Instance.new("Frame")
flyPanel.Size = UDim2.new(1, -40, 0, 200)
flyPanel.Position = UDim2.new(0, 20, 1, -210)
flyPanel.BackgroundColor3 = Color3.fromRGB(20, 20, 35)
flyPanel.Visible = false
flyPanel.Parent = gui

Instance.new("UICorner", flyPanel).CornerRadius = UDim.new(0, 10)

-- Simple fly buttons
local function createFlyBtn(text, pos)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 60, 0, 60)
    btn.Position = pos
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    btn.Text = text
    btn.TextColor3 = Color3.white
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 20
    btn.Parent = flyPanel
    
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
    
    return btn
end

local flyF = createFlyBtn("F", UDim2.new(0.3, -30, 0.2, -30))
local flyB = createFlyBtn("B", UDim2.new(0.7, -30, 0.2, -30))
local flyL = createFlyBtn("L", UDim2.new(0.1, -30, 0.5, -30))
local flyR = createFlyBtn("R", UDim2.new(0.9, -30, 0.5, -30))
local flyU = createFlyBtn("U", UDim2.new(0.3, -30, 0.8, -30))
local flyD = createFlyBtn("D", UDim2.new(0.7, -30, 0.8, -30))
local exitFly = createBtn("ExitFly", "EXIT FLY", 0.8, Color3.fromRGB(255, 60, 60))
exitFly.Size = UDim2.new(0.8, 0, 0, 35)
exitFly.Position = UDim2.new(0.1, 0, 1, -40)
exitFly.Parent = flyPanel

-- Marker functions
local function createMarker(pos, idx)
    local marker = Instance.new("Part")
    marker.Name = "Mark_" .. idx
    marker.Size = Vector3.new(2, 2, 2)
    marker.Position = pos
    marker.Anchored = true
    marker.CanCollide = false
    marker.Transparency = 0.4
    marker.Color = Color3.fromHSV(idx/8, 1, 1)
    marker.Parent = Workspace
    
    local light = Instance.new("PointLight")
    light.Color = marker.Color
    light.Brightness = 2
    light.Range = 10
    light.Parent = marker
    
    return marker
end

local function updateUI()
    local count = #markers
    if isFlying then
        status.Text = string.format("FLYING MODE\nMarkers: %d/5\nUse buttons to move", count)
    elseif isViewing then
        status.Text = string.format("VIEWING MARK %d/%d\nTap to rotate", currentMarker, count)
    else
        status.Text = string.format("FLIGHT SYSTEM\nMarkers: %d/5\nReady", count)
    end
end

local function placeMarker()
    if #markers >= 5 then return end
    
    local cam = Workspace.CurrentCamera
    local pos = cam.CFrame.Position
    
    local marker = createMarker(pos, #markers + 1)
    table.insert(markers, {position = pos, part = marker})
    
    updateUI()
end

local function clearMarkers()
    for _, m in ipairs(markers) do
        if m.part then m.part:Destroy() end
    end
    markers = {}
    currentMarker = 0
    updateUI()
end

local function startFlying()
    if isFlying then return end
    
    isFlying = true
    isViewing = false
    local cam = Workspace.CurrentCamera
    flyPos = cam.CFrame.Position
    
    cam.CameraType = Enum.CameraType.Scriptable
    flyPanel.Visible = true
    panel.Visible = false
    
    updateUI()
end

local function stopFlying()
    isFlying = false
    Workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    flyPanel.Visible = false
    panel.Visible = true
    updateUI()
end

local function startViewing()
    if #markers == 0 then return end
    
    isViewing = true
    isFlying = false
    currentMarker = 1
    
    Workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable
    flyPanel.Visible = false
    panel.Visible = false
    
    updateUI()
end

local function stopViewing()
    isViewing = false
    Workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    panel.Visible = true
    updateUI()
end

local function switchMarker(dir)
    if #markers == 0 then return end
    
    if dir == "next" then
        currentMarker = currentMarker + 1
        if currentMarker > #markers then currentMarker = 1 end
    else
        currentMarker = currentMarker - 1
        if currentMarker < 1 then currentMarker = #markers end
    end
    
    updateUI()
end

-- Button connections
flyBtn.MouseButton1Click:Connect(startFlying)
markBtn.MouseButton1Click:Connect(placeMarker)
viewBtn.MouseButton1Click:Connect(startViewing)
clearBtn.MouseButton1Click:Connect(clearMarkers)
exitFly.MouseButton1Click:Connect(stopFlying)

-- Fly control connections
flyF.MouseButton1Down:Connect(function() flyDir.F = true end)
flyF.MouseButton1Up:Connect(function() flyDir.F = false end)
flyB.MouseButton1Down:Connect(function() flyDir.B = true end)
flyB.MouseButton1Up:Connect(function() flyDir.B = false end)
flyL.MouseButton1Down:Connect(function() flyDir.L = true end)
flyL.MouseButton1Up:Connect(function() flyDir.L = false end)
flyR.MouseButton1Down:Connect(function() flyDir.R = true end)
flyR.MouseButton1Up:Connect(function() flyDir.R = false end)
flyU.MouseButton1Down:Connect(function() flyDir.U = true end)
flyU.MouseButton1Up:Connect(function() flyDir.U = false end)
flyD.MouseButton1Down:Connect(function() flyDir.D = true end)
flyD.MouseButton1Up:Connect(function() flyDir.D = false end)

-- Keyboard shortcuts
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.F then
        if isFlying then stopFlying() else startFlying() end
    elseif input.KeyCode == Enum.KeyCode.M then
        placeMarker()
    elseif input.KeyCode == Enum.KeyCode.V then
        if isViewing then stopViewing() else startViewing() end
    elseif input.KeyCode == Enum.KeyCode.C then
        clearMarkers()
    elseif input.KeyCode == Enum.KeyCode.H then
        panel.Visible = not panel.Visible
    end
end)

-- Main loop
RunService.Heartbeat:Connect(function(dt)
    if isFlying then
        local cam = Workspace.CurrentCamera
        local move = Vector3.new(0, 0, 0)
        
        if flyDir.F then move = move + cam.CFrame.LookVector end
        if flyDir.B then move = move - cam.CFrame.LookVector end
        if flyDir.R then move = move + cam.CFrame.RightVector end
        if flyDir.L then move = move - cam.CFrame.RightVector end
        if flyDir.U then move = move + Vector3.new(0, 1, 0) end
        if flyDir.D then move = move - Vector3.new(0, 1, 0) end
        
        if move.Magnitude > 0 then
            move = move.Unit * 25 * dt
            flyPos = flyPos + move
        end
        
        cam.CFrame = CFrame.new(flyPos, flyPos + cam.CFrame.LookVector)
        
    elseif isViewing and #markers > 0 then
        local cam = Workspace.CurrentCamera
        local mark = markers[currentMarker]
        
        if mark then
            local time = tick()
            local radius = 12
            local height = 5
            
            local x = math.cos(time * 0.3) * radius
            local z = math.sin(time * 0.3) * radius
            
            local pos = mark.position + Vector3.new(x, height, z)
            local look = mark.position + Vector3.new(0, 2, 0)
            
            cam.CFrame = cam.CFrame:Lerp(CFrame.new(pos, look), 5 * dt)
        end
    end
end)

-- Touch rotation for viewing
local touchStart
local origAngle

UserInputService.TouchStarted:Connect(function(touch)
    if not isViewing then return end
    touchStart = touch.Position
    origAngle = viewAngle
end)

UserInputService.InputChanged:Connect(function(input)
    if not isViewing or not touchStart or input.UserInputType ~= Enum.UserInputType.Touch then
        return
    end
    
    local delta = input.Position - touchStart
    viewAngle = Vector2.new(
        origAngle.X - delta.X * 0.005,
        origAngle.Y - delta.Y * 0.005
    )
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        touchStart = nil
    end
end)

-- Initial update
updateUI()

-- Load notification
task.spawn(function()
    local notify = Instance.new("TextLabel")
    notify.Size = UDim2.new(0, 250, 0, 60)
    notify.Position = UDim2.new(0.5, -125, 0.1, 0)
    notify.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    notify.Text = "Flight System Loaded\nF=Fly, M=Mark, V=View"
    notify.TextColor3 = Color3.white
    notify.Font = Enum.Font.GothamMedium
    notify.TextSize = 14
    notify.Parent = gui
    
    Instance.new("UICorner", notify).CornerRadius = UDim.new(0, 10)
    
    task.wait(2)
    
    for i = 0, 1, 0.1 do
        notify.BackgroundTransparency = i
        notify.TextTransparency = i
        task.wait(0.05)
    end
    
    notify:Destroy()
end)

-- Cleanup
gui.Destroying:Connect(function()
    clearMarkers()
end)

print("Compact Flight System loaded!")
