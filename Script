--=[ МОБИЛЬНЫЙ СКРИПТ ДЛЯ THE FORGE ]=--
--=[ Свободная камера + удалённое взаимодействие ]=--

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Состояние системы
local FreeCameraMode = false
local Agent = nil
local CameraOrigin = nil

-- 1. СОЗДАНИЕ ИНТЕРФЕЙСА (уже работало)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ForgeMobileHelper"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false

-- Главная кнопка меню
local MenuButton = Instance.new("TextButton")
MenuButton.Name = "MenuToggle"
MenuButton.Size = UDim2.new(0, 60, 0, 60)
MenuButton.Position = UDim2.new(0, 20, 0, 20)
MenuButton.BackgroundColor3 = Color3.fromRGB(45, 85, 150)
MenuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MenuButton.Text = "☰"
MenuButton.Font = Enum.Font.GothamBold
MenuButton.TextSize = 28
MenuButton.BorderSizePixel = 0
MenuButton.ZIndex = 10

local UICorner1 = Instance.new("UICorner")
UICorner1.CornerRadius = UDim.new(0.2, 0)
UICorner1.Parent = MenuButton

-- Панель управления
local ControlPanel = Instance.new("Frame")
ControlPanel.Name = "ControlPanel"
ControlPanel.Size = UDim2.new(0, 220, 0, 180)
ControlPanel.Position = UDim2.new(0, 90, 0, 20)
ControlPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
ControlPanel.BackgroundTransparency = 0.1
ControlPanel.Visible = false

local UICorner2 = Instance.new("UICorner")
UICorner2.CornerRadius = UDim.new(0.1, 0)
UICorner2.Parent = ControlPanel

-- Кнопка переключения камеры
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleFreeCam"
ToggleButton.Size = UDim2.new(0.9, 0, 0, 50)
ToggleButton.Position = UDim2.new(0.05, 0, 0.05, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(80, 160, 80)
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Font = Enum.Font.Gotham
ToggleButton.TextSize = 20
ToggleButton.Text = "▶ Вкл. Своб. Камеру"
ToggleButton.Parent = ControlPanel

local UICorner3 = Instance.new("UICorner")
UICorner3.CornerRadius = UDim.new(0.15, 0)
UICorner3.Parent = ToggleButton

-- Индикатор состояния
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "Status"
StatusLabel.Size = UDim2.new(0.9, 0, 0, 30)
StatusLabel.Position = UDim2.new(0.05, 0, 0.4, 0)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Режим: ВЫКЛ"
StatusLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 16
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = ControlPanel

-- Кнопка закрытия
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "ClosePanel"
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -35, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 18
CloseButton.Parent = ControlPanel

local UICorner4 = Instance.new("UICorner")
UICorner4.CornerRadius = UDim.new(0.5, 0)
UICorner4.Parent = CloseButton

MenuButton.Parent = ScreenGui
ControlPanel.Parent = ScreenGui

-- 2. ЯДРО СВОБОДНОЙ КАМЕРЫ
local Camera = workspace.CurrentCamera
local TouchStartPos = nil
local CameraYaw = 0
local CameraPitch = 0
local CameraDistance = 10

-- Функция управления камерой в свободном режиме
function UpdateFreeCamera()
    if not FreeCameraMode or not CameraOrigin then return end
    
    -- Вычисляем новую позицию камеры (орбита вокруг агента)
    local angleX = math.rad(CameraYaw)
    local angleY = math.rad(CameraPitch)
    
    local offset = Vector3.new(
        CameraDistance * math.cos(angleX) * math.cos(angleY),
        CameraDistance * math.sin(angleY),
        CameraDistance * math.sin(angleX) * math.cos(angleY)
    )
    
    Camera.CFrame = CFrame.new(CameraOrigin.Position + offset, CameraOrigin.Position)
end

-- Обработка жестов для управления камерой
UserInputService.TouchStarted:Connect(function(touch, gameProcessed)
    if not FreeCameraMode or gameProcessed then return end
    
    TouchStartPos = touch.Position
    local startYaw = CameraYaw
    local startPitch = CameraPitch
    
    -- Отслеживаем движение пальца
    local touchConnection
    touchConnection = UserInputService.TouchMoved:Connect(function(currentTouch)
        if not FreeCameraMode or not TouchStartPos then return end
        
        local delta = currentTouch.Position - TouchStartPos
        CameraYaw = startYaw - delta.X * 0.5  -- Чувствительность
        CameraPitch = startPitch + delta.Y * 0.3
        CameraPitch = math.clamp(CameraPitch, -80, 80)  -- Ограничение по вертикали
        
        UpdateFreeCamera()
    end)
    
    -- Завершение касания
    UserInputService.TouchEnded:Connect(function(endTouch)
        if touchConnection then
            touchConnection:Disconnect()
            TouchStartPos = nil
        end
    end)
end)

-- 3. УПРАВЛЕНИЕ РЕЖИМОМ
function ToggleFreeCamera()
    FreeCameraMode = not FreeCameraMode
    
    if FreeCameraMode then
        -- АКТИВАЦИЯ РЕЖИМА
        local character = LocalPlayer.Character
        if character then
            -- Замораживаем персонажа
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 0
                humanoid.JumpPower = 0
            end
            
            -- Создаём агента для взаимодействий
            Agent = Instance.new("Part")
            Agent.Name = "InteractionAgent"
            Agent.Size = Vector3.new(3, 5, 3)
            Agent.Transparency = 1
            Agent.CanCollide = false
            Agent.Anchored = true
            Agent.Parent = workspace
            Agent.CFrame = character:GetPivot()
            
            CameraOrigin = Agent
            
            -- Сохраняем начальные углы камеры
            local lookVector = Camera.CFrame.LookVector
            CameraYaw = math.atan2(lookVector.Z, lookVector.X)
            CameraPitch = math.asin(lookVector.Y)
            
            -- Меняем интерфейс
            ToggleButton.Text = "⏸ Выкл. Своб. Камеру"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
            StatusLabel.Text = "Режим: АКТИВЕН"
            StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            
            print("Свободная камера активирована. Двигайте пальцем по экрану для вращения.")
        end
    else
        -- ДЕАКТИВАЦИЯ РЕЖИМА
        local character = LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 16
                humanoid.JumpPower = 50
            end
        end
        
        -- Возвращаем камеру к персонажу
        Camera.CameraType = Enum.CameraType.Custom
        
        -- Удаляем агента
        if Agent then
            Agent:Destroy()
            Agent = nil
        end
        
        CameraOrigin = nil
        
        -- Меняем интерфейс
        ToggleButton.Text = "▶ Вкл. Своб. Камеру"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(80, 160, 80)
        StatusLabel.Text = "Режим: ВЫКЛ"
        StatusLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
        
        print("Свободная камера деактивирована.")
    end
end

-- 4. СИСТЕМА ВЗАИМОДЕЙСТВИЯ
function RemoteInteract(target)
    if not Agent or not FreeCameraMode then 
        print("Ошибка: Агент не создан или режим не активен")
        return 
    end
    
    -- Определяем тип объекта
    local targetName = target.Name:lower()
    local parentName = target.Parent.Name:lower()
    
    print("Обнаружен объект:", targetName, "в", parentName)
    
    -- Варианты объектов для добычи
    local oreKeywords = {"ore", "руд", "stone", "камень", "mine", "копать"}
    -- Варианты врагов
    local enemyKeywords = {"mob", "enemy", "monster", "враг", "монстр", "boss"}
    
    -- Проверка на руду
    for _, keyword in pairs(oreKeywords) do
        if targetName:find(keyword) or parentName:find(keyword) then
            -- Способ 1: ClickDetector (стандартный)
            local clickDetector = target:FindFirstChild("ClickDetector") or target.Parent:FindFirstChild("ClickDetector")
            if clickDetector then
                fireclickdetector(clickDetector)
                print("Добыча через ClickDetector")
                return true
            end
            
            -- Способ 2: Tool/RemoteEvent (для продвинутых игр)
            local tool = LocalPlayer.Backpack:FindFirstChildOfClass("Tool") or character:FindFirstChildOfClass("Tool")
            if tool then
                tool:Activate()
                print("Добыча через инструмент")
                return true
            end
            
            print("Не найден способ добычи для этого объекта")
            return false
        end
    end
    
    -- Проверка на врагов
    for _, keyword in pairs(enemyKeywords) do
        if targetName:find(keyword) or parentName:find(keyword) then
            local humanoid = target:FindFirstChild("Humanoid") or target.Parent:FindFirstChild("Humanoid")
            if humanoid then
                humanoid:TakeDamage(15)
                print("Атака по врагу: -15 HP")
                return true
            end
        end
    end
    
    -- Если объект не опознан, пытаемся стандартное взаимодействие
    local clickDetector = target:FindFirstChild("ClickDetector")
    if clickDetector then
        fireclickdetector(clickDetector)
        print("Стандартное взаимодействие")
        return true
    end
    
    print("Не удалось взаимодействовать с объектом")
    return false
end

-- 5. ОБРАБОТКА КАСАНИЙ ДЛЯ ВЗАИМОДЕЙСТВИЯ
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not FreeCameraMode or gameProcessed then return end
    
    if input.UserInputType == Enum.UserInputType.Touch then
        -- Небольшая задержка, чтобы не путать с жестами камеры
        task.wait(0.1)
        
        -- Создаём луч от камеры через точку касания
        local viewportMouse = Camera:ViewportPointToRay(input.Position.X, input.Position.Y)
        local ray = Ray.new(viewportMouse.Origin, viewportMouse.Direction * 100)
        
        -- Ищем объект, игнорируя агента и камеру
        local ignoreList = {Agent, Camera, workspace.CurrentCamera}
        local hit, position = workspace:FindPartOnRayWithIgnoreList(ray, ignoreList)
        
        if hit then
            print("Касание объекта:", hit.Name)
            RemoteInteract(hit)
        end
    end
end)

-- 6. ОБРАБОТЧИКИ ИНТЕРФЕЙСА
MenuButton.MouseButton1Click:Connect(function()
    ControlPanel.Visible = not ControlPanel.Visible
    print("Панель управления: " .. (ControlPanel.Visible and "открыта" or "закрыта"))
end)

CloseButton.MouseButton1Click:Connect(function()
    ControlPanel.Visible = false
    print("Панель управления закрыта")
end)

ToggleButton.MouseButton1Click:Connect(ToggleFreeCamera)

-- 7. ОСНОВНОЙ ЦИКЛ ОБНОВЛЕНИЯ
RunService.RenderStepped:Connect(function()
    if FreeCameraMode then
        UpdateFreeCamera()
    end
end)

-- Инструкция
print("========================================")
print("Мобильный скрипт для The Forge загружен!")
print("Инструкция:")
print("1. Нажмите кнопку '☰' для открытия панели")
print("2. Нажмите 'Вкл. Своб. Камеру' для активации")
print("3. В режиме камеры: двигайте пальцем по экрану для вращения")
print("4. Нажимайте на руду/монстров для взаимодействия")
print("========================================")
