-- Основные службы
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Состояние
local FreeCameraMode = false
local Agent = nil -- Наш невидимый "агент" для взаимодействий

-- 1. СОЗДАЕМ ИНТЕРФЕЙС ДЛЯ МОБИЛЬНОГО УСТРОЙСТВА
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ForgeMobileHelper"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false

-- Главная кнопка меню в левом верхнем углу
local MenuButton = Instance.new("TextButton")
MenuButton.Name = "MenuToggle"
MenuButton.Size = UDim2.new(0, 60, 0, 60)
MenuButton.Position = UDim2.new(0, 20, 0, 20)
MenuButton.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
MenuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MenuButton.Text = "≡"
MenuButton.Font = Enum.Font.GothamBold
MenuButton.TextSize = 28
MenuButton.BorderSizePixel = 0
MenuButton.ZIndex = 10

-- Закругление
local UICorner1 = Instance.new("UICorner")
UICorner1.CornerRadius = UDim.new(0.2, 0)
UICorner1.Parent = MenuButton

-- Панель управления (появляется при нажатии)
local ControlPanel = Instance.new("Frame")
ControlPanel.Name = "ControlPanel"
ControlPanel.Size = UDim2.new(0, 220, 0, 150)
ControlPanel.Position = UDim2.new(0, 90, 0, 20)
ControlPanel.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
ControlPanel.BackgroundTransparency = 0.2
ControlPanel.Visible = false -- Скрыта по умолчанию

local UICorner2 = Instance.new("UICorner")
UICorner2.CornerRadius = UDim.new(0.1, 0)
UICorner2.Parent = ControlPanel

-- Кнопка включения свободной камеры
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleFreeCam"
ToggleButton.Size = UDim2.new(0.9, 0, 0, 50)
ToggleButton.Position = UDim2.new(0.05, 0, 0.05, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Font = Enum.Font.Gotham
ToggleButton.TextSize = 20
ToggleButton.Text = "Вкл. Своб. Камеру"
ToggleButton.Parent = ControlPanel

local UICorner3 = Instance.new("UICorner")
UICorner3.CornerRadius = UDim.new(0.15, 0)
UICorner3.Parent = ToggleButton

-- Кнопка закрытия панели
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "ClosePanel"
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -35, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 18
CloseButton.Parent = ControlPanel

local UICorner4 = Instance.new("UICorner")
UICorner4.CornerRadius = UDim.new(0.5, 0)
UICorner4.Parent = CloseButton

-- Прикрепляем элементы
MenuButton.Parent = ScreenGui
ControlPanel.Parent = ScreenGui

-- 2. ФУНКЦИИ УПРАВЛЕНИЯ
-- Включение/выключение свободной камеры
function ToggleFreeCamera()
    FreeCameraMode = not FreeCameraMode

    if FreeCameraMode then
        -- Сохраняем и замораживаем персонажа
        local character = LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 0
                -- Создаём невидимого агента для взаимодействий
                if not Agent then
                    Agent = Instance.new("Part")
                    Agent.Name = "InteractionAgent"
                    Agent.Size = Vector3.new(2, 4, 2)
                    Agent.Transparency = 1
                    Agent.CanCollide = false
                    Agent.Anchored = true
                    Agent.Parent = workspace
                end
                Agent.CFrame = character:GetPivot()
            end
        end
        ToggleButton.Text = "Выкл. Своб. Камеру"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 80, 80)
    else
        -- Возвращаем управление персонажем
        local character = LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 16 -- Стандартная скорость
            end
        end
        -- Удаляем агента
        if Agent then
            Agent:Destroy()
            Agent = nil
        end
        ToggleButton.Text = "Вкл. Своб. Камеру"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
    end
end

-- Функция удалённого взаимодействия (добыча, атака)
function RemoteInteract(target)
    if not Agent or not FreeCameraMode then return end

    -- Определяем тип объекта по имени
    local targetName = target.Name:lower()

    if targetName:find("ore") or targetName:find("руд") then
        -- Добыча руды: ищем ClickDetector
        local clickDetector = target:FindFirstChild("ClickDetector")
        if clickDetector then
            fireclickdetector(clickDetector)
        end
    elseif targetName:find("mob") or targetName:find("enemy") or targetName:find("monster") then
        -- Атака моба: эмулируем удар
        local humanoid = target:FindFirstChild("Humanoid")
        if humanoid then
            humanoid:TakeDamage(10) -- Базовый урон, можно настроить
        end
    end
end

-- 3. ОБРАБОТЧИКИ СОБЫТИЙ
-- Открытие/закрытие панели управления
MenuButton.MouseButton1Click:Connect(function()
    ControlPanel.Visible = not ControlPanel.Visible
end)

CloseButton.MouseButton1Click:Connect(function()
    ControlPanel.Visible = false
end)

-- Кнопка переключения камеры
ToggleButton.MouseButton1Click:Connect(ToggleFreeCamera)

-- Обработка нажатий на игровые объекты (для мобильных устройств)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not FreeCameraMode or gameProcessed then return end

    if input.UserInputType == Enum.UserInputType.Touch then
        -- Для тач-устройств: получаем позицию касания
        local target = workspace:FindPartOnRayWithIgnoreList(
            Ray.new(workspace.CurrentCamera.CFrame.Position, 
                   workspace.CurrentCamera.CFrame.LookVector * 100),
            {workspace.CurrentCamera, Agent}
        )
        if target and target.Parent then
            RemoteInteract(target)
        end
    end
end)

print("Мобильный скрипт для The Forge активирован!")
print("Используйте кнопку в левом верхнем углу для управления.")
